<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gymflow.mapper.CourseMapper">

    <resultMap id="CourseVOMap" type="com.gymflow.vo.CourseVO">
        <id property="id" column="id"/>
        <result property="courseType" column="course_type"/>
        <result property="courseName" column="course_name"/>
        <result property="description" column="description"/>
        <result property="coachId" column="coach_id"/>
        <result property="coachName" column="coach_name"/>
        <result property="coachAvatar" column="coach_avatar"/>
        <result property="maxCapacity" column="max_capacity"/>
        <result property="currentEnrollment" column="current_enrollment"/>
        <result property="courseDate" column="course_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="duration" column="duration"/>
        <result property="price" column="price"/>
        <result property="location" column="location"/>
        <result property="status" column="status"/>
        <result property="signCode" column="sign_code"/>
        <result property="createTime" column="create_time"/>
        <result property="remainingSlots" column="remaining_slots"/>
    </resultMap>

    <select id="selectCoursePage" resultMap="CourseVOMap">
        SELECT
        c.*,
        co.real_name as coach_name,
        co.avatar as coach_avatar,
        (c.max_capacity - c.current_enrollment) as remaining_slots
        FROM course c
        LEFT JOIN coach co ON c.coach_id = co.id
        WHERE 1=1
        <if test="courseType != null and courseType != ''">
            AND c.course_type = #{courseType}
        </if>
        <if test="status != null and status != ''">
            AND c.status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
            c.course_name LIKE CONCAT('%', #{keyword}, '%')
            OR co.real_name LIKE CONCAT('%', #{keyword}, '%')
            OR c.location LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY c.course_date DESC, c.start_time
    </select>

    <select id="selectAvailableCourses" resultMap="CourseVOMap">
        SELECT
        c.*,
        co.real_name as coach_name,
        co.avatar as coach_avatar,
        (c.max_capacity - c.current_enrollment) as remaining_slots
        FROM course c
        LEFT JOIN coach co ON c.coach_id = co.id
        WHERE c.status = 'UPCOMING'
        AND c.course_date >= CURDATE()
        <if test="courseType != null and courseType != ''">
            AND c.course_type = #{courseType}
        </if>
        <if test="date != null">
            AND c.course_date = #{date}
        </if>
        AND (c.max_capacity IS NULL OR c.current_enrollment &lt; c.max_capacity)
        ORDER BY c.course_date, c.start_time
    </select>

    <select id="selectCoachCourses" resultMap="CourseVOMap">
        SELECT
        c.*,
        (c.max_capacity - c.current_enrollment) as remaining_slots
        FROM course c
        WHERE c.coach_id = #{coachId}
        <if test="date != null">
            AND c.course_date = #{date}
        </if>
        <if test="status != null and status != ''">
            AND c.status = #{status}
        </if>
        ORDER BY c.course_date, c.start_time
    </select>

    <select id="selectCourseDetail" resultMap="CourseVOMap">
        SELECT
            c.*,
            co.real_name as coach_name,
            co.avatar as coach_avatar,
            (c.max_capacity - c.current_enrollment) as remaining_slots
        FROM course c
                 LEFT JOIN coach co ON c.coach_id = co.id
        WHERE c.id = #{courseId}
    </select>

</mapper>