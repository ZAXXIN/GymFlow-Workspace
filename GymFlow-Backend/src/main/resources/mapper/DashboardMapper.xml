<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gymflow.mapper.DashboardMapper">

    <select id="selectIncomeTrend" resultType="java.util.Map">
        SELECT
            DATE(payment_time) as date,
            COALESCE(SUM(actual_amount), 0) as amount
        FROM `order`
        WHERE payment_status = 'PAID'
          AND payment_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        GROUP BY DATE(payment_time)
        ORDER BY date
    </select>

    <select id="selectMemberGrowthTrend" resultType="java.util.Map">
        SELECT
            DATE(create_time) as date,
            COUNT(*) as count
        FROM member
        WHERE create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        GROUP BY DATE(create_time)
        ORDER BY date
    </select>

    <select id="selectCoachIncomeRanking" resultType="java.util.Map">
        SELECT
            c.id,
            c.real_name,
            c.avatar,
            COUNT(DISTINCT o.id) as order_count,
            COALESCE(SUM(o.actual_amount), 0) as total_amount
        FROM coach c
                 LEFT JOIN course co ON c.id = co.coach_id
                 LEFT JOIN `order` o ON co.id = o.product_id
            AND o.order_type = 'COURSE'
            AND o.payment_status = 'PAID'
            AND o.payment_time >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
        WHERE c.status = 1
        GROUP BY c.id, c.real_name, c.avatar
        ORDER BY total_amount DESC
            LIMIT #{limit}
    </select>

    <select id="selectHotCourseTypes" resultType="java.util.Map">
        SELECT
            course_type,
            COUNT(*) as course_count,
            SUM(current_enrollment) as total_enrollment
        FROM course
        WHERE course_date >= CURDATE()
          AND status = 'UPCOMING'
        GROUP BY course_type
        ORDER BY total_enrollment DESC
            LIMIT #{limit}
    </select>

    <select id="selectMemberActivityDistribution" resultType="java.util.Map">
        SELECT
            CASE
                WHEN checkin_count >= 10 THEN '非常活跃'
                WHEN checkin_count >= 5 THEN '活跃'
                WHEN checkin_count >= 1 THEN '一般'
                ELSE '不活跃'
                END as activity_level,
            COUNT(*) as member_count
        FROM (
                 SELECT
                     m.id,
                     COUNT(ci.id) as checkin_count
                 FROM member m
                          LEFT JOIN check_in ci ON m.id = ci.member_id
                     AND ci.checkin_time >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
                     AND ci.status = 'SUCCESS'
                 GROUP BY m.id
             ) as activity_stats
        GROUP BY activity_level
        ORDER BY FIELD(activity_level, '非常活跃', '活跃', '一般', '不活跃')
    </select>

</mapper>